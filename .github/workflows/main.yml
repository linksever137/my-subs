name: Update Sub (DrissionPage)

on:
  schedule:
    # 每 4 小时运行一次
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  bypass-waf-drission:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          # 安装 DrissionPage，它不需要 chromedriver，没有版本烦恼
          pip install DrissionPage

      - name: Run Bypass Script
        env:
          TARGET_URL: ${{ secrets.CF_SUB_URL }}
        run: |
          cat << 'EOF' > bypass.py
          from DrissionPage import ChromiumPage, ChromiumOptions
          import time
          import os
          import sys

          # 1. 获取 URL
          url = os.environ.get("TARGET_URL")
          if not url:
              print("Error: SECRET URL not found!")
              sys.exit(1)

          # 2. 配置浏览器 (无头模式，专门针对 Linux 环境优化)
          co = ChromiumOptions()
          co.set_argument('--headless=new') # 新版无头模式
          co.set_argument('--no-sandbox')
          co.set_argument('--disable-gpu')
          # 伪装 User-Agent，防止被轻易识别为脚本
          co.set_argument('--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36')

          print("Starting Browser...")
          try:
              page = ChromiumPage(co)
              
              print(f"Navigating to {url} ...")
              page.get(url)
              
              # 3. 智能等待 Cloudflare
              # DrissionPage 操控浏览器的特征更少，通常过盾更快
              # 但我们还是给足 25 秒
              print("Waiting 25 seconds for Cloudflare challenge...")
              time.sleep(25)
              
              # 4. 获取网页 body 的文本
              # Cloudflare 验证通过后，Body 里应该就是纯 Base64 字符串
              content = page.ele('tag:body').text
              
              # 调试：打印前 50 个字符看看抓到了什么
              print(f"Preview content: {content[:50]}")

              # 5. 检查是否失败
              if "Just a moment" in content or "Enable JavaScript" in content:
