name: Update Subscription (Debug)

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  download-debug:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download with Secret UA
        run: |
          # === 这里的 User-Agent 必须和你 Cloudflare 填的一模一样 ===
          MY_UA="GitHubActionsBypass"
          # ========================================================
          
          echo "Using User-Agent: $MY_UA"
          
          # 下载文件
          curl -v -L -A "$MY_UA" "${{ secrets.CF_SUB_URL }}" -o sub.txt
          
          # 检查文件内容
          if grep -q "<!DOCTYPE html>" sub.txt; then
             echo "========================================"
             echo "❌ 失败：仍然被 Cloudflare 拦截"
             echo "以下是 Cloudflare 返回的页面内容（前20行）："
             echo "========================================"
             head -n 20 sub.txt
             echo "========================================"
             echo "请检查 Cloudflare WAF 规则中是否勾选了 'Browser Integrity Check' 和 'Security Level'"
             exit 1
          fi
          
          if [ ! -s sub.txt ]; then
            echo "❌ 失败：文件为空"
            exit 1
          fi
          
          echo "✅ 成功：获取到订阅内容"

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add sub.txt
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Update sub: $(date)"
            git push
          fi
