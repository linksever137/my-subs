name: Update Sub (TLS Impersonate)

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  bypass-tls:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install curl_cffi
        run: |
          # 安装支持 TLS 伪装的库
          pip install curl_cffi

      - name: Download Subscription
        env:
          TARGET_URL: ${{ secrets.CF_SUB_URL }}
        run: |
          cat << 'EOF' > download.py
          from curl_cffi import requests
          import os
          import sys

          url = os.environ.get("TARGET_URL")
          if not url:
              print("Error: URL not found!")
              sys.exit(1)

          print(f"Target: {url}")

          try:
              # 关键：impersonate="chrome120" 模拟 Chrome 120 的 TLS 指纹
              # 这比普通的 User-Agent 伪装要深层得多
              response = requests.get(
                  url, 
                  impersonate="chrome120", 
                  timeout=30,
                  allow_redirects=True
              )

              print(f"Status Code: {response.status_code}")
              content = response.text

              # 调试：打印前 200 个字符，让你在日志里看到结果
              print("-" * 50)
              print(f"Preview Content:\n{content[:200]}")
              print("-" * 50)

              # 检查是否被拦截
              if "<!DOCTYPE html>" in content or "Just a moment" in content:
                  print("❌ Failed: Blocked by Cloudflare (HTML detected).")
                  sys.exit(1)

              if not content:
                  print("❌ Failed: Empty content.")
                  sys.exit(1)

              # 保存文件
              with open("sub.txt", "w", encoding="utf-8") as f:
                  f.write(content)
              print("✅ Download Success!")

          except Exception as e:
              print(f"❌ Error: {e}")
              sys.exit(1)
          EOF
          
          python download.py

      - name: Force Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # 检查文件
          if [ ! -s sub.txt ]; then
             echo "Error: sub.txt missing or empty."
             exit 1
          fi

          git add sub.txt
          
          # 检查是否有变化
          if git diff --staged --quiet; then
            echo "========================================"
            echo "⚠️  注意：文件内容与上次完全一致，无需更新。"
            echo "这不是脚本错误，而是因为订阅提供商还没更新节点信息。"
            echo "========================================"
          else
            git commit -m "Update sub via curl_cffi: $(date)"
            git push
            echo "✅ 成功推送到仓库！"
          fi
